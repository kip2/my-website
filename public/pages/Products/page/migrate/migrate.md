
![migrate](/pages/Products/page/migrate/img/migrate.jpg)

:::LittleBlank

---  

使用言語：Rust  
作成日 : 2024/04/13  
作成期間：12日(うち、実作業時間は8日)  
総コミット数：42コミット  
Github : [GitHub - migrate](https://github.com/kip2/migrate)  

---  

## 概要  

Rust製の、データベースマイグレーションファイル。  
MySQLとPostgreSQLに対応している。  

### 使い方

使い方としては以下のような手順。  

- .envファイルにDBへの接続情報を記載する。  
- `migrate -i`コマンドを使用し、DBにマイグレーション管理用テーブルを作成する。  
- `migrate -c`コマンドで、マイグレーション用の`up`と`down`ファイルを作成する。  
- `up`ファイルと`down`ファイルに、実行したいDDL文を記載する。`up`ファイルはテーブルクリエイトやカラムの追加や変更文を。`down`ファイルには、`up`ファイルで行なった変更を戻すためのDDL文を記載する。  
- `migrate`でマイグレーションを実行する。`up`ファイル記載のDDL文が実行される。  


### ロールバックも可能

なお、ロールバックも可能になっている。  

- `migrate -r`コマンドで、実行されたマイグレーションのロールバックが行われる。  
- 回数指定も可能で、`migrate -r 2`と記載した場合は、2回分、ロールバックが行われる。回数を指定しない場合はデフォルトで、すべてのマイグレーションをロールバックする。  

### ヘルプ

コマンドについてのヘルプも参照可能となっている。  

:::LittleBlank

```shell  
migrate -h  
```  

### このツールについて  

最初はMySQLのみに対応予定だったし、そのつもりで作成していた。  
が、試しに使用していたところ、マイグレーションのロールバックが失敗することが起きていた。  
なぜか調査したところ、理由としては浮上したのは以下のようなもの。  

- MySQLの仕様では、トランザクション内であっても、DDL文は実行の段階で暗黙的にコミットされてしまう。  
- なので、`up`ファイルにエラーが起きて失敗するDDL文が混じっていると、途中までの変更が反映されてしまい、ロールバック時が上手くいかない。元のテーブルの状態に戻らず、途中で反映された変更がのこってしまう。  

上記の理由のため、MySQLを諦め、暗黙にコミットしないPostgreSQLを使用することになったので、PostgreSQLで実装する必要が出てきた。  
しかし、MySQLでせっかく作ったものを無くすのも惜しいので、こちらはMySQL用のものとして残し、PostgreSQL用のものは別にリポジトリを立てて作成した(この時は、sqlxの仕様で両対応が可能とはわかっていなかったので、別にリポジトリを分けて作成している)。  

:::LittleBlank

なお、その時作成したものはこちら。  
[GitHub - migrate-PostgreSQL](https://github.com/kip2/migrate-PostgreSQL)  

:::LittleBlank

この時、ツールとして要件を満たしていないと思っていたので、こちらのツールは諦める予定であった。  

:::LittleBlank

しかし、上記の問題についてRecursionCSのコミュニティ内で相談したところ。  

- そもそもマイグレーションファイルに記載されるSQL文はエラーのないSQL文が書かれるべきである。  
- マイグレーションは本番環境で行うものである。  
- マイグレーションファイルのSQL文の正しさは、開発環境などの、閉じた環境内で実行することで保証する。  
- 開発環境でのSQL文のテスト時には、DBのバックアップという手段を使って行うこと。  
という回答があった。  

結局、マイグレーションに関する自分の不理解によるものだったので、実際に仕様するDBはMySQLに変更。  
晴れて、こちらのツールが再び日の目を見ることになったという形。  

:::LittleBlank

そして、その後の調査でsqlxの記載のやり方によれば、MySQLにもPostgreSQLの両方にも対応が可能なことが判明した。  
そういうわけで、両対応のバージョンとして統合したものがこちらのツール。  

:::LittleBlank

なお、こちらのツールも、RecursionCSのバックエンドプロジェクトで使用するために作成した。  
